{% extends "base.html" %}

{% block title %}Analytics Dashboard - FibroTracker{% endblock %}

{% block page_title %}Analytics Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
    
    <!-- KPI Cards Section -->
    <div class="kpi-section">
        <div class="stat-card" id="avg-pain-card">
            <div class="stat-header">
                <div class="stat-icon blue">
                    <i class="fas fa-fire-alt"></i>
                </div>
                <span class="stat-change positive" id="pain-trend">
                    <i class="fas fa-arrow-up"></i> --
                </span>
            </div>
            <div class="stat-value" id="avg-pain-value">--</div>
            <div class="stat-label">Average Pain Score</div>
            <div class="stat-subtitle">Last 7 days</div>
        </div>

        <div class="stat-card" id="avg-fatigue-card">
            <div class="stat-header">
                <div class="stat-icon orange">
                    <i class="fas fa-battery-half"></i>
                </div>
                <span class="stat-change" id="fatigue-trend">
                    <i class="fas fa-minus"></i> --
                </span>
            </div>
            <div class="stat-value" id="avg-fatigue-value">--</div>
            <div class="stat-label">Average Fatigue</div>
            <div class="stat-subtitle">Last 7 days</div>
        </div>

        <div class="stat-card" id="avg-sleep-card">
            <div class="stat-header">
                <div class="stat-icon teal">
                    <i class="fas fa-moon"></i>
                </div>
                <span class="stat-change" id="sleep-trend">
                    <i class="fas fa-arrow-down"></i> --
                </span>
            </div>
            <div class="stat-value" id="avg-sleep-value">--</div>
            <div class="stat-label">Sleep Quality</div>
            <div class="stat-subtitle">Last 7 days</div>
        </div>

        <div class="stat-card" id="tracking-days-card">
            <div class="stat-header">
                <div class="stat-icon green">
                    <i class="fas fa-calendar-check"></i>
                </div>
            </div>
            <div class="stat-value" id="tracking-days-value">--</div>
            <div class="stat-label">Days Tracked</div>
            <div class="stat-subtitle">Total entries logged</div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="dashboard-grid">
        
        <!-- Daily Trends Chart -->
        <div class="chart-card full-width">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-chart-line"></i>
                    Daily Symptom Trends
                </div>
                <div class="card-actions">
                    <select id="trend-timeframe" class="select-minimal">
                        <option value="7">Last 7 Days</option>
                        <option value="14">Last 14 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                    </select>
                    <button class="icon-btn" onclick="refreshDailyChart()" title="Refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="daily-trends-chart"></canvas>
            </div>
        </div>

        <!-- Weekly Averages Chart -->
        <div class="chart-card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-chart-bar"></i>
                    Weekly Averages
                </div>
                <button class="icon-btn" onclick="exportWeeklyData()" title="Export Data">
                    <i class="fas fa-download"></i>
                </button>
            </div>
            <div class="chart-container">
                <canvas id="weekly-chart"></canvas>
            </div>
            <div class="chart-legend">
                <div class="legend-item">
                    <span class="legend-color" style="background: #1e40af;"></span>
                    <span>Pain</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #f59e0b;"></span>
                    <span>Fatigue</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #0d9488;"></span>
                    <span>Sleep</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #6b7280;"></span>
                    <span>Stress</span>
                </div>
            </div>
        </div>

        <!-- Correlation Matrix -->
        <div class="chart-card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-project-diagram"></i>
                    Symptom Correlations
                </div>
                <button class="icon-btn" onclick="toggleCorrelationView()" title="Toggle View">
                    <i class="fas fa-exchange-alt"></i>
                </button>
            </div>
            <div class="chart-container">
                <canvas id="correlation-chart"></canvas>
            </div>
            <div class="correlation-insight">
                <i class="fas fa-info-circle"></i>
                <span id="correlation-text">Loading correlation insights...</span>
            </div>
        </div>

        <!-- AI Insights Card -->
        <div class="insights-card full-width">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-brain"></i>
                    AI-Powered Insights & Recommendations
                </div>
                <button class="btn btn-outline btn-sm" onclick="regenerateInsights()">
                    <i class="fas fa-redo"></i> Regenerate
                </button>
            </div>
            <div id="ai-insights-container" class="insights-content">
                <div class="loading-state">
                    <div class="spinner-sm"></div>
                    <p>Analyzing your health data...</p>
                </div>
            </div>
        </div>

        <!-- Symptom Distribution -->
        <div class="chart-card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-circle-notch"></i>
                    Symptom Distribution
                </div>
            </div>
            <div class="chart-container">
                <canvas id="distribution-chart"></canvas>
            </div>
        </div>

        <!-- Recent Activity Timeline -->
        <div class="activity-card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-clock"></i>
                    Recent Activity
                </div>
                <a href="{{ url_for('daily_entry_page') }}" class="btn btn-outline btn-sm">
                    <i class="fas fa-plus"></i> New Entry
                </a>
            </div>
            <div class="timeline" id="activity-timeline">
                <div class="loading-state">
                    <div class="spinner-sm"></div>
                    <p>Loading recent entries...</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Quick Actions Footer -->
    <div class="dashboard-footer">
        <div class="quick-action-card" onclick="window.location.href='{{ url_for('daily_entry_page') }}'">
            <i class="fas fa-plus-circle"></i>
            <span>Add Daily Entry</span>
        </div>
        <div class="quick-action-card" onclick="window.location.href='{{ url_for('report_page') }}'">
            <i class="fas fa-file-export"></i>
            <span>Generate Report</span>
        </div>
        <div class="quick-action-card" onclick="window.location.href='{{ url_for('chat_page') }}'">
            <i class="fas fa-comments"></i>
            <span>Ask AI Assistant</span>
        </div>
    </div>

</div>

<script>
// Global chart instances
let dailyTrendsChart, weeklyChart, correlationChart, distributionChart;

// Chart.js default configuration
Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto';
Chart.defaults.font.size = 13;
Chart.defaults.color = '#6b7280';

// Professional color palette
const COLORS = {
    primary: '#1e40af',
    primaryLight: '#3b82f6',
    secondary: '#0d9488',
    accent: '#f59e0b',
    success: '#10b981',
    danger: '#dc2626',
    warning: '#f59e0b',
    gray: '#6b7280',
    grayLight: '#e5e7eb'
};

// Load Dashboard Data
async function loadDashboard() {
    showLoading();
    
    try {
        // Parallel data fetching for better performance
        const [dailyData, weeklyData, aiData, trackingData] = await Promise.all([
            fetch('/api/dashboard/daily').then(r => r.json()),
            fetch('/api/dashboard/weekly').then(r => r.json()),
            fetch('/api/dashboard/ai-suggestions').then(r => r.json()),
            fetch('/api/tracking-day').then(r => r.json())
        ]);

        // Update KPIs
        updateKPICards(dailyData, trackingData);
        
        // Render Charts
        renderDailyTrendsChart(dailyData);
        renderWeeklyChart(weeklyData);
        renderCorrelationChart(dailyData);
        renderDistributionChart(dailyData);
        
        // Render AI Insights
        renderAIInsights(aiData);
        
        // Render Activity Timeline
        renderActivityTimeline(dailyData);
        
    } catch (error) {
        console.error('Dashboard loading error:', error);
        showToast('Error loading dashboard data', 'error');
    }
    
    hideLoading();
}

// Update KPI Cards
function updateKPICards(dailyData, trackingData) {
    if (!Array.isArray(dailyData) || dailyData.length === 0) return;
    
    // Get last 7 days data
    const last7Days = dailyData.slice(-7);
    const previous7Days = dailyData.slice(-14, -7);
    
    // Calculate averages
    const avgPain = calculateAverage(last7Days, 'pain_score');
    const avgFatigue = calculateAverage(last7Days, 'fatigue_score');
    const avgSleep = calculateAverage(last7Days, 'sleep');
    
    const prevAvgPain = calculateAverage(previous7Days, 'pain_score');
    const prevAvgFatigue = calculateAverage(previous7Days, 'fatigue_score');
    const prevAvgSleep = calculateAverage(previous7Days, 'sleep');
    
    // Update values
    document.getElementById('avg-pain-value').textContent = avgPain.toFixed(1);
    document.getElementById('avg-fatigue-value').textContent = avgFatigue.toFixed(1);
    document.getElementById('avg-sleep-value').textContent = avgSleep.toFixed(1);
    document.getElementById('tracking-days-value').textContent = trackingData.tracking_day || dailyData.length;
    
    // Update trends
    updateTrend('pain-trend', avgPain, prevAvgPain, true);
    updateTrend('fatigue-trend', avgFatigue, prevAvgFatigue, true);
    updateTrend('sleep-trend', avgSleep, prevAvgSleep, false);
}

function calculateAverage(data, field) {
    if (!data || data.length === 0) return 0;
    const sum = data.reduce((acc, item) => acc + (parseFloat(item[field]) || 0), 0);
    return sum / data.length;
}

function updateTrend(elementId, current, previous, lowerIsBetter) {
    const element = document.getElementById(elementId);
    if (!element || previous === 0) return;
    
    const change = ((current - previous) / previous * 100).toFixed(1);
    const isPositive = lowerIsBetter ? change < 0 : change > 0;
    
    element.className = `stat-change ${isPositive ? 'positive' : 'negative'}`;
    element.innerHTML = `
        <i class="fas fa-arrow-${change > 0 ? 'up' : 'down'}"></i>
        ${Math.abs(change)}%
    `;
}

// Render Daily Trends Chart
function renderDailyTrendsChart(data) {
    const ctx = document.getElementById('daily-trends-chart').getContext('2d');
    
    if (dailyTrendsChart) dailyTrendsChart.destroy();
    
    // Get timeframe
    const timeframe = parseInt(document.getElementById('trend-timeframe').value);
    const filteredData = data.slice(-timeframe);
    
    dailyTrendsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: filteredData.map(d => formatDate(d.entry_date)),
            datasets: [
                {
                    label: 'Pain Score',
                    data: filteredData.map(d => d.pain_score),
                    borderColor: COLORS.primary,
                    backgroundColor: hexToRgba(COLORS.primary, 0.1),
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: COLORS.primary,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                },
                {
                    label: 'Fatigue Score',
                    data: filteredData.map(d => d.fatigue_score),
                    borderColor: COLORS.accent,
                    backgroundColor: hexToRgba(COLORS.accent, 0.1),
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: COLORS.accent,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                },
                {
                    label: 'Sleep Quality',
                    data: filteredData.map(d => d.sleep),
                    borderColor: COLORS.secondary,
                    backgroundColor: hexToRgba(COLORS.secondary, 0.1),
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: COLORS.secondary,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                },
                {
                    label: 'Stress Level',
                    data: filteredData.map(d => d.stress_score),
                    borderColor: COLORS.gray,
                    backgroundColor: hexToRgba(COLORS.gray, 0.1),
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: COLORS.gray,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    align: 'end',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: { weight: '500' }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#111827',
                    bodyColor: '#374151',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}/10`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 10,
                    grid: {
                        color: '#f3f4f6',
                        drawBorder: false
                    },
                    ticks: {
                        stepSize: 2,
                        callback: function(value) {
                            return value + '/10';
                        }
                    }
                },
                x: {
                    grid: {
                        display: false,
                        drawBorder: false
                    },
                    ticks: {
                        maxRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 10
                    }
                }
            }
        }
    });
}

// Render Weekly Chart
function renderWeeklyChart(data) {
    const ctx = document.getElementById('weekly-chart').getContext('2d');
    
    if (weeklyChart) weeklyChart.destroy();
    
    weeklyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => `Week ${d.week_number}`),
            datasets: [
                {
                    label: 'Pain',
                    data: data.map(d => d.avg_pain),
                    backgroundColor: hexToRgba(COLORS.primary, 0.8),
                    borderRadius: 6,
                    borderSkipped: false
                },
                {
                    label: 'Fatigue',
                    data: data.map(d => d.avg_fatigue),
                    backgroundColor: hexToRgba(COLORS.accent, 0.8),
                    borderRadius: 6,
                    borderSkipped: false
                },
                {
                    label: 'Sleep',
                    data: data.map(d => d.avg_sleep),
                    backgroundColor: hexToRgba(COLORS.secondary, 0.8),
                    borderRadius: 6,
                    borderSkipped: false
                },
                {
                    label: 'Stress',
                    data: data.map(d => d.avg_stress),
                    backgroundColor: hexToRgba(COLORS.gray, 0.8),
                    borderRadius: 6,
                    borderSkipped: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#111827',
                    bodyColor: '#374151',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}/10`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 10,
                    grid: {
                        color: '#f3f4f6'
                    },
                    ticks: {
                        stepSize: 2
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Render Correlation Chart
function renderCorrelationChart(data) {
    const ctx = document.getElementById('correlation-chart').getContext('2d');
    
    if (correlationChart) correlationChart.destroy();
    
    // Calculate correlations
    const painSleep = calculateCorrelation(data, 'pain_score', 'sleep');
    const painStress = calculateCorrelation(data, 'pain_score', 'stress_score');
    const fatigueStress = calculateCorrelation(data, 'fatigue_score', 'stress_score');
    
    correlationChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['Pain-Sleep', 'Pain-Stress', 'Fatigue-Stress', 'Sleep-Mood', 'Pain-Fatigue'],
            datasets: [{
                label: 'Correlation Strength',
                data: [
                    Math.abs(painSleep) * 10,
                    Math.abs(painStress) * 10,
                    Math.abs(fatigueStress) * 10,
                    7.5, // Placeholder
                    8.2  // Placeholder
                ],
                backgroundColor: hexToRgba(COLORS.primary, 0.2),
                borderColor: COLORS.primary,
                borderWidth: 2,
                pointBackgroundColor: COLORS.primary,
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: COLORS.primary
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 10,
                    ticks: {
                        stepSize: 2
                    },
                    grid: {
                        color: '#f3f4f6'
                    }
                }
            }
        }
    });
    
    // Update correlation insight
    const strongestCorr = Math.max(Math.abs(painSleep), Math.abs(painStress), Math.abs(fatigueStress));
    let insightText = '';
    
    if (strongestCorr > 0.7) {
        insightText = 'Strong correlation detected between pain and sleep quality. Focus on improving sleep hygiene.';
    } else if (strongestCorr > 0.4) {
        insightText = 'Moderate correlations found. Consider tracking additional factors.';
    } else {
        insightText = 'Weak correlations. Symptoms may be influenced by multiple independent factors.';
    }
    
    document.getElementById('correlation-text').textContent = insightText;
}

// Render Distribution Chart
function renderDistributionChart(data) {
    const ctx = document.getElementById('distribution-chart').getContext('2d');
    
    if (distributionChart) distributionChart.destroy();
    
    // Calculate distribution
    const painDist = calculateDistribution(data, 'pain_score');
    
    distributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Low (0-3)', 'Moderate (4-6)', 'High (7-10)'],
            datasets: [{
                data: [painDist.low, painDist.moderate, painDist.high],
                backgroundColor: [
                    hexToRgba(COLORS.success, 0.8),
                    hexToRgba(COLORS.accent, 0.8),
                    hexToRgba(COLORS.danger, 0.8)
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${percentage}%`;
                        }
                    }
                }
            }
        }
    });
}

// Render AI Insights
function renderAIInsights(data) {
    const container = document.getElementById('ai-insights-container');
    
    if (data.ai_advice) {
        const insights = data.ai_advice.split('\n').filter(line => line.trim());
        
        container.innerHTML = `
            <div class="insights-grid">
                ${insights.map((insight, index) => `
                    <div class="insight-item" style="animation-delay: ${index * 0.1}s">
                        <div class="insight-icon">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="insight-content">
                            <p>${insight}</p>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-chart-line"></i>
                <p>Keep tracking your symptoms daily to receive personalized AI insights.</p>
                <a href="{{ url_for('daily_entry_page') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Entry
                </a>
            </div>
        `;
    }
}

// Render Activity Timeline
function renderActivityTimeline(data) {
    const container = document.getElementById('activity-timeline');
    const recentData = data.slice(-5).reverse();
    
    if (recentData.length === 0) {
        container.innerHTML = `
            <div class="empty-state-sm">
                <p>No recent activity. Start tracking your symptoms!</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = recentData.map(entry => `
        <div class="timeline-item">
            <div class="timeline-marker"></div>
            <div class="timeline-content">
                <div class="timeline-date">${formatDate(entry.entry_date)}</div>
                <div class="timeline-stats">
                    <span class="timeline-stat">
                        <i class="fas fa-fire"></i> Pain: ${entry.pain_score}/10
                    </span>
                    <span class="timeline-stat">
                        <i class="fas fa-battery-half"></i> Fatigue: ${entry.fatigue_score}/10
                    </span>
                    <span class="timeline-stat">
                        <i class="fas fa-moon"></i> Sleep: ${entry.sleep}/10
                    </span>
                </div>
            </div>
        </div>
    `).join('');
}

// Utility Functions
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

function calculateCorrelation(data, field1, field2) {
    if (!data || data.length < 2) return 0;
    
    const x = data.map(d => parseFloat(d[field1]) || 0);
    const y = data.map(d => parseFloat(d[field2]) || 0);
    
    const n = x.length;
    const sumX = x.reduce((a, b) => a + b, 0);
    const sumY = y.reduce((a, b) => a + b, 0);
    const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
    const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
    const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);
    
    const numerator = n * sumXY - sumX * sumY;
    const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
    
    return denominator === 0 ? 0 : numerator / denominator;
}

function calculateDistribution(data, field) {
    if (!data || data.length === 0) return { low: 0, moderate: 0, high: 0 };
    
    const dist = { low: 0, moderate: 0, high: 0 };
    
    data.forEach(entry => {
        const value = parseFloat(entry[field]) || 0;
        if (value <= 3) dist.low++;
        else if (value <= 6) dist.moderate++;
        else dist.high++;
    });
    
    return dist;
}

// Event Handlers
function refreshDailyChart() {
    loadDashboard();
}

function exportWeeklyData() {
    window.location.href = '/api/report/weekly/export-excel';
}

function toggleCorrelationView() {
    showToast('Correlation view toggled', 'info');
}

async function regenerateInsights() {
    showLoading();
    try {
        const response = await fetch('/api/dashboard/ai-suggestions');
        const data = await response.json();
        renderAIInsights(data);
        showToast('Insights regenerated successfully', 'success');
    } catch (error) {
        showToast('Error regenerating insights', 'error');
    }
    hideLoading();
}

// Timeframe change handler
document.addEventListener('DOMContentLoaded', () => {
    const timeframeSelect = document.getElementById('trend-timeframe');
    if (timeframeSelect) {
        timeframeSelect.addEventListener('change', refreshDailyChart);
    }
});

// Initialize Dashboard
window.addEventListener('load', loadDashboard);
</script>

<style>
/* Dashboard-specific styles */
.dashboard-container {
    padding: 0;
}

.kpi-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-subtitle {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.chart-card {
    grid-column: span 6;
}

.chart-card.full-width {
    grid-column: span 12;
}

.insights-card {
    grid-column: span 12;
}

.activity-card {
    grid-column: span 6;
}

.card-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.select-minimal {
    padding: 0.375rem 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-sm);
    background: var(--white);
    font-size: 0.85rem;
    cursor: pointer;
}

.icon-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: var(--gray-100);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition-fast);
    color: var(--text-secondary);
}

.icon-btn:hover {
    background: var(--gray-200);
    color: var(--primary-blue);
}

.chart-container {
    position: relative;
    height: 320px;
    padding: 1rem 0;
}

.chart-legend {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    padding-top: 1rem;
    border-top: 1px solid var(--gray-200);
    margin-top: 1rem;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 3px;
}

.correlation-insight {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: var(--gray-50);
    border-radius: var(--radius);
    margin-top: 1rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.correlation-insight i {
    color: var(--primary-blue);
    font-size: 1.1rem;
}

.insights-content {
    min-height: 150px;
}

.insights-grid {
    display: grid;
    gap: 1rem;
}

.insight-item {
    display: flex;
    gap: 1rem;
    padding: 1.25rem;
    background: linear-gradient(135deg, rgba(30, 64, 175, 0.03), rgba(13, 148, 136, 0.03));
    border-radius: var(--radius-md);
    border-left: 3px solid var(--primary-blue);
    animation: slideInLeft 0.5s ease;
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.insight-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--radius);
    background: linear-gradient(135deg, var(--primary-blue), var(--secondary-teal));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.insight-content p {
    margin: 0;
    line-height: 1.7;
    color: var(--text-primary);
}

.timeline {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-height: 400px;
    overflow-y: auto;
}

.timeline-item {
    display: flex;
    gap: 1rem;
    position: relative;
}

.timeline-item:not(:last-child)::before {
    content: '';
    position: absolute;
    left: 8px;
    top: 24px;
    bottom: -12px;
    width: 2px;
    background: var(--gray-200);
}

.timeline-marker {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--primary-blue);
    border: 3px solid var(--white);
    box-shadow: 0 0 0 2px var(--gray-200);
    flex-shrink: 0;
    margin-top: 4px;
}

.timeline-content {
    flex: 1;
    padding-bottom: 0.5rem;
}

.timeline-date {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.timeline-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}

.timeline-stat {
    font-size: 0.85rem;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 0.375rem;
}

.timeline-stat i {
    color: var(--primary-blue);
}

.dashboard-footer {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 2rem;
}

.quick-action-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem;
    background: var(--card-bg);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition-fast);
    box-shadow: var(--shadow-sm);
}

.quick-action-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
    border-color: var(--primary-blue);
}

.quick-action-card i {
    font-size: 1.75rem;
    color: var(--primary-blue);
}

.quick-action-card span {
    font-weight: 500;
    color: var(--text-primary);
}

.loading-state, .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 2rem;
    text-align: center;
}

.loading-state i, .empty-state i {
    font-size: 3rem;
    color: var(--gray-400);
    margin-bottom: 1rem;
}

.spinner-sm {
    width: 30px;
    height: 30px;
    border: 3px solid var(--gray-200);
    border-top-color: var(--primary-blue);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

.empty-state-sm {
    padding: 2rem;
    text-align: center;
    color: var(--text-muted);
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
}

@media (max-width: 1024px) {
    .chart-card, .activity-card {
        grid-column: span 12;
    }
}

@media (max-width: 768px) {
    .kpi-section {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .dashboard-footer {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
