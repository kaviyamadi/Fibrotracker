{% extends "base.html" %}

{% block title %}Profile - FibroTracker{% endblock %}

{% block page_title %}Your Health Profile{% endblock %}

{% block content %}
<div class="profile-page">
    <!-- Profile Header -->
    <div class="profile-header card">
        <div class="profile-avatar-section">
            <div class="profile-avatar">
                <i class="fas fa-user-circle"></i>
            </div>
            <div class="profile-user-info">
                <h2 id="username-display">{{ session.get('username', 'User') }}</h2>
                <p class="user-email" id="email-display">user@example.com</p>
                <span class="profile-badge">Active Patient</span>
            </div>
        </div>
        <div class="profile-completion">
            <div class="completion-circle" id="completion-circle">
                <svg width="100" height="100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#e5e7eb" stroke-width="6"></circle>
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#1e40af" stroke-width="6" stroke-dasharray="283"
                        stroke-dashoffset="283" id="progress-circle"
                        style="transform: rotate(-90deg); transform-origin: 50% 50%;"></circle>
                </svg>
                <div class="completion-text">
                    <span class="completion-percentage" id="completion-percentage">0%</span>
                </div>
            </div>
            <p class="completion-label">Profile Complete</p>
        </div>
    </div>

    <!-- Screening Status Section -->
    <div class="profile-section card" id="screening-section">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-clipboard-check"></i>
                <h3>Fibromyalgia Screening Status</h3>
            </div>
            <span class="completion-badge" id="screening-badge">Checking...</span>
        </div>
        <div class="screening-status-content" id="screening-content" style="padding-top: 1rem;">
            <!-- Content populated by JS -->
            <p class="text-muted">Loading screening status...</p>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="profile-stats-grid">
        <div class="stat-card-mini">
            <i class="fas fa-calendar-check"></i>
            <div class="stat-mini-info">
                <span class="stat-mini-value" id="days-tracked">0</span>
                <span class="stat-mini-label">Days Tracked</span>
            </div>
        </div>
        <div class="stat-card-mini">
            <i class="fas fa-file-medical"></i>
            <div class="stat-mini-info">
                <span class="stat-mini-value" id="entries-count">0</span>
                <span class="stat-mini-label">Total Entries</span>
            </div>
        </div>

        <div class="stat-card-mini">
            <i class="fas fa-calendar-day"></i>
            <div class="stat-mini-info">
                <span class="stat-mini-value" id="member-since">--</span>
                <span class="stat-mini-label">Member Since</span>
            </div>
        </div>
    </div>

    <!-- Profile Form -->
    <form id="profile-form">
        <!-- Personal Information Section -->
        <div class="profile-section card">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-user"></i>
                    <h3>Personal Information</h3>
                </div>
                <span class="completion-badge" id="personal-completion">0/2 Complete</span>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="sex">
                        <i class="fas fa-venus-mars"></i> Biological Sex
                        <span class="required">*</span>
                    </label>
                    <div class="select-card-group">
                        <label class="select-card">
                            <input type="radio" name="sex" value="Male">
                            <div class="card-content">
                                <i class="fas fa-mars"></i>
                                <span>Male</span>
                            </div>
                        </label>
                        <label class="select-card">
                            <input type="radio" name="sex" value="Female">
                            <div class="card-content">
                                <i class="fas fa-venus"></i>
                                <span>Female</span>
                            </div>
                        </label>
                        <label class="select-card">
                            <input type="radio" name="sex" value="Other">
                            <div class="card-content">
                                <i class="fas fa-genderless"></i>
                                <span>Other</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="age_group">
                        <i class="fas fa-birthday-cake"></i> Age Group
                        <span class="required">*</span>
                    </label>
                    <select id="age_group" name="age_group" class="form-select">
                        <option value="">Select your age group</option>
                        <option value="18-25">18-25 years</option>
                        <option value="26-35">26-35 years</option>
                        <option value="36-45">36-45 years</option>
                        <option value="46-55">46-55 years</option>
                        <option value="56-65">56-65 years</option>
                        <option value="65+">65+ years</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Medical History Section -->
        <div class="profile-section card">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-notes-medical"></i>
                    <h3>Medical History</h3>
                </div>
                <span class="completion-badge" id="medical-completion">0/2 Complete</span>
            </div>

            <div class="form-group">
                <label for="comorbidities">
                    <i class="fas fa-heartbeat"></i> Comorbidities
                    <span class="help-tooltip" title="List any other health conditions you have">
                        <i class="fas fa-info-circle"></i>
                    </span>
                </label>
                <div class="tags-input-wrapper">
                    <div class="tags-container" id="comorbidities-tags"></div>
                    <input type="text" id="comorbidities-input" class="form-control"
                        placeholder="Type condition and press Enter (e.g., Arthritis, Diabetes)">
                </div>
                <div class="common-conditions">
                    <span class="condition-tag" onclick="addComorbidity('Depression')">+ Depression</span>
                    <span class="condition-tag" onclick="addComorbidity('Anxiety')">+ Anxiety</span>
                    <span class="condition-tag" onclick="addComorbidity('Arthritis')">+ Arthritis</span>
                    <span class="condition-tag" onclick="addComorbidity('IBS')">+ IBS</span>
                    <span class="condition-tag" onclick="addComorbidity('Migraines')">+ Migraines</span>
                </div>
                <input type="hidden" id="comorbidities" name="comorbidities">
            </div>

           <div class="form-group">
    <label>
        <i class="fas fa-users"></i> Family History of Fibromyalgia or Chronic Pain
        <span class="help-tooltip" title="Any family members diagnosed with fibromyalgia or chronic pain conditions">
            <i class="fas fa-info-circle"></i>
        </span>
    </label>

    <div class="select-pills">
        <label class="pill-option">
            <input type="radio" name="family_history" value="Yes">
            <span>Yes</span>
        </label>

        <label class="pill-option">
            <input type="radio" name="family_history" value="No">
            <span>No</span>
        </label>
    </div>
</div>
        <!-- Health Factors Section -->
        <div class="profile-section card">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-clipboard-list"></i>
                    <h3>Health Factors</h3>
                </div>
                <span class="completion-badge" id="factors-completion">0/2 Complete</span>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="menstrual_cycle">
                        <i class="fas fa-calendar-alt"></i> Menstrual Cycle
                        <span class="optional">(if applicable)</span>
                    </label>
                    <div class="select-pills">
                        <label class="pill-option">
                            <input type="radio" name="menstrual_cycle" value="N/A">
                            <span>N/A</span>
                        </label>
                        <label class="pill-option">
                            <input type="radio" name="menstrual_cycle" value="Regular">
                            <span>Regular</span>
                        </label>
                        <label class="pill-option">
                            <input type="radio" name="menstrual_cycle" value="Irregular">
                            <span>Irregular</span>
                        </label>
                        <label class="pill-option">
                            <input type="radio" name="menstrual_cycle" value="Postmenopausal">
                            <span>Postmenopausal</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="weather_sensitivity">
                        <i class="fas fa-cloud-sun"></i> Weather Sensitivity
                        <span class="help-tooltip" title="How much do weather changes affect your symptoms?">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </label>
                    <div class="sensitivity-scale">
                        <label class="sensitivity-option">
                            <input type="radio" name="weather_sensitivity" value="None">
                            <div class="sensitivity-card">
                                <i class="fas fa-check-circle"></i>
                                <span>None</span>
                            </div>
                        </label>
                        <label class="sensitivity-option">
                            <input type="radio" name="weather_sensitivity" value="Low">
                            <div class="sensitivity-card">
                                <i class="fas fa-cloud"></i>
                                <span>Low</span>
                            </div>
                        </label>
                        <label class="sensitivity-option">
                            <input type="radio" name="weather_sensitivity" value="Moderate">
                            <div class="sensitivity-card">
                                <i class="fas fa-cloud-rain"></i>
                                <span>Moderate</span>
                            </div>
                        </label>
                        <label class="sensitivity-option">
                            <input type="radio" name="weather_sensitivity" value="High">
                            <div class="sensitivity-card">
                                <i class="fas fa-cloud-showers-heavy"></i>
                                <span>High</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Account Settings Section -->
        <div class="profile-section card">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-cog"></i>
                    <h3>Notification Preferences</h3>
                </div>
            </div>

            <div class="notification-settings">
                <div class="notification-item">
                    <div class="notification-info">
                        <i class="fas fa-bell"></i>
                        <div>
                            <h4>Daily Reminders</h4>
                            <p>Get reminded to log your daily symptoms</p>
                        </div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="daily-reminders" checked>
                        <span class="switch-slider"></span>
                    </label>
                </div>

                <div class="notification-item">
                    <div class="notification-info">
                        <i class="fas fa-chart-line"></i>
                        <div>
                            <h4>Weekly Reports</h4>
                            <p>Receive weekly summary of your symptoms</p>
                        </div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="weekly-reports" checked>
                        <span class="switch-slider"></span>
                    </label>
                </div>

                <div class="notification-item">
                    <div class="notification-info">
                        <i class="fas fa-robot"></i>
                        <div>
                            <h4>AI Insights</h4>
                            <p>Get personalized health insights and tips</p>
                        </div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="ai-insights" checked>
                        <span class="switch-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="profile-actions">
            <button type="button" class="btn btn-outline" onclick="resetForm()">
                <i class="fas fa-undo"></i> Reset Changes
            </button>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-save"></i> Save Profile
            </button>
        </div>
    </form>

    <!-- Danger Zone -->
    <div class="profile-section card danger-zone">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Danger Zone</h3>
            </div>
        </div>
        <div class="danger-content">
            <div class="danger-item">
                <div class="danger-info">
                    <h4>Export Your Data</h4>
                    <p>Download all your health data in JSON format</p>
                </div>
                <button type="button" class="btn btn-outline" onclick="exportData()">
                    <i class="fas fa-download"></i> Export Data
                </button>
            </div>
            <div class="danger-item">
                <div class="danger-info">
                    <h4>Delete Account</h4>
                    <p>Permanently delete your account and all data</p>
                </div>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteAccount()">
                    <i class="fas fa-trash-alt"></i> Delete Account
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let comorbidities = [];
    let originalFormData = {};

    // Initialize on page load
    window.addEventListener('load', async () => {
        await loadProfile();
        await loadScreeningStatus();
        await loadUserStats();
        updateCompletion();
    });

    // Load profile data
    async function loadProfile() {
        showLoading();
        try {
            const response = await fetch('/api/profile');
            const data = await response.json();

            if (response.ok) {
                // Personal info
                if (data.sex) {
                    document.querySelector(`input[name="sex"][value="${data.sex}"]`).checked = true;
                }
                if (data.age_group) {
                    document.getElementById('age_group').value = data.age_group;
                }

                // Medical history
                if (data.comorbidities) {
                    comorbidities = data.comorbidities.split(',').map(c => c.trim()).filter(c => c);
                    renderComorbiditiesTags();
                }
                document.getElementById('family_history').value = data.family_history || '';

                // Health factors
                if (data.menstrual_cycle) {
                    document.querySelector(`input[name="menstrual_cycle"][value="${data.menstrual_cycle}"]`).checked = true;
                }
                if (data.weather_sensitivity) {
                    document.querySelector(`input[name="weather_sensitivity"][value="${data.weather_sensitivity}"]`).checked = true;
                }

                // Store original data
                originalFormData = { ...data };
                updateCompletion();
            }
        } catch (error) {
            console.error('Error loading profile:', error);
            showToast('Error loading profile', 'error');
        }
        hideLoading();
    }

    // Load user statistics
    async function loadUserStats() {
        try {
            const [trackingRes, entriesRes] = await Promise.all([
                fetch('/api/tracking-day'),
                fetch('/api/dashboard/daily')
            ]);

            const trackingData = await trackingRes.json();
            const entriesData = await entriesRes.json();

            document.getElementById('days-tracked').textContent = trackingData.tracking_day || 0;
            document.getElementById('entries-count').textContent = Array.isArray(entriesData) ? entriesData.length : 0;

            if (Array.isArray(entriesData) && entriesData.length > 0) {
                // Future status
            }

            // Set member since (mock - replace with actual registration date from backend)
            document.getElementById('member-since').textContent = 'Jan 2025';

        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    async function loadScreeningStatus() {
        try {
            const response = await fetch('/api/latest-screening');
            const data = await response.json();

            const badge = document.getElementById('screening-badge');
            const content = document.getElementById('screening-content');

            if (data && data.created_at) {
                const date = new Date(data.created_at).toLocaleDateString();
                const riskClass = data.risk_level === 'High' ? 'danger' : (data.risk_level === 'Moderate' ? 'warning' : 'success');
                const riskIcon = data.risk_level === 'High' ? 'exclamation-triangle' : (data.risk_level === 'Moderate' ? 'info-circle' : 'check-circle');

                badge.textContent = `Completed: ${date}`;
                badge.className = 'completion-badge success'; // or dynamic color

                content.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <div class="stat-icon ${riskClass === 'danger' ? 'red-bg' : (riskClass === 'warning' ? 'orange-bg' : 'green-bg')}" 
                             style="width: 50px; height: 50px; display:flex; align-items:center; justify-content:center; border-radius:12px;">
                            <i class="fas fa-${riskIcon}" style="color: white; font-size: 1.5rem;"></i>
                        </div>
                        <div>
                            <h4 style="margin: 0; color: var(--gray-900);">Risk Level: <span style="color: var(--${riskClass === 'danger' ? 'error' : (riskClass === 'warning' ? 'warning' : 'success')}); font-weight:700;">${data.risk_level} Risk</span></h4>
                            <p style="margin: 0; font-size: 0.9rem; color: var(--gray-600);">
                                ${data.meets_criteria ? 'Meets diagnostic criteria' : 'Does not meet diagnostic criteria'}
                            </p>
                        </div>
                    </div>
                    
                    <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <small style="display:block; color:var(--gray-500);">FiRST Score</small>
                                <strong style="font-size:1.1rem;">${data.first_score || 0}/6</strong>
                            </div>
                            <div>
                                <small style="display:block; color:var(--gray-500);">Criteria Status</small>
                                <strong style="font-size:1.1rem;">${data.meets_criteria ? 'Eligible' : 'Not Eligible'}</strong>
                            </div>
                            ${data.bmi ? `
                            <div>
                                <small style="display:block; color:var(--gray-500);">BMI</small>
                                <strong style="font-size:1.1rem;">${data.bmi}</strong>
                            </div>` : ''}
                            ${data.duration ? `
                            <div>
                                <small style="display:block; color:var(--gray-500);">Symptom Duration</small>
                                <strong style="font-size:1.1rem; text-transform: capitalize;">${data.duration.replace(/_/g, ' ')}</strong>
                            </div>` : ''}
                        </div>
                    </div>

                    <a href="/screening" class="btn btn-outline btn-sm">
                        <i class="fas fa-redo"></i> Retake Screening
                    </a>
                `;
            } else {
                badge.textContent = 'Not Taken';
                badge.className = 'completion-badge';
                content.innerHTML = `
                    <p class="text-muted" style="margin-bottom: 1rem;">You haven't completed the fibromyalgia screening assessment yet.</p>
                    <a href="/screening" class="btn btn-primary btn-sm">
                        <i class="fas fa-play"></i> Take Screening Now
                    </a>
                `;
            }
        } catch (error) {
            console.error('Error loading screening status:', error);
            document.getElementById('screening-content').innerHTML = '<p class="text-error">Error loading status</p>';
        }
    }

    // Comorbidities tags management
    function addComorbidity(condition) {
        condition = condition.trim();
        if (condition && !comorbidities.includes(condition)) {
            comorbidities.push(condition);
            renderComorbiditiesTags();
            updateCompletion();
        }
    }

    function removeComorbidity(condition) {
        comorbidities = comorbidities.filter(c => c !== condition);
        renderComorbiditiesTags();
        updateCompletion();
    }

    function renderComorbiditiesTags() {
        const container = document.getElementById('comorbidities-tags');
        container.innerHTML = comorbidities.map(condition => `
        <span class="tag">
            ${condition}
            <i class="fas fa-times" onclick="removeComorbidity('${condition}')"></i>
        </span>
    `).join('');
        document.getElementById('comorbidities').value = comorbidities.join(', ');
    }

    // Comorbidities input handler
    document.getElementById('comorbidities-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addComorbidity(e.target.value);
            e.target.value = '';
        }
    });

    // Update completion tracking
    function updateCompletion() {
        let totalFields = 0;
        let completedFields = 0;

        // Personal info (2 fields)
        const sex = document.querySelector('input[name="sex"]:checked');
        const ageGroup = document.getElementById('age_group').value;
        if (sex) completedFields++;
        if (ageGroup) completedFields++;
        totalFields += 2;
        document.getElementById('personal-completion').textContent = `${sex ? 1 : 0 + (ageGroup ? 1 : 0)}/2 Complete`;

        // Medical history (2 fields)
        if (comorbidities.length > 0) completedFields++;
        if (document.getElementById('family_history').value.trim()) completedFields++;
        totalFields += 2;
        document.getElementById('medical-completion').textContent =
            `${(comorbidities.length > 0 ? 1 : 0) + (document.getElementById('family_history').value.trim() ? 1 : 0)}/2 Complete`;

        // Health factors (2 fields)
        const menstrual = document.querySelector('input[name="menstrual_cycle"]:checked');
        const weather = document.querySelector('input[name="weather_sensitivity"]:checked');
        if (menstrual) completedFields++;
        if (weather) completedFields++;
        totalFields += 2;
        document.getElementById('factors-completion').textContent =
            `${(menstrual ? 1 : 0) + (weather ? 1 : 0)}/2 Complete`;

        // Update circular progress
        const percentage = Math.round((completedFields / totalFields) * 100);
        document.getElementById('completion-percentage').textContent = `${percentage}%`;

        const circle = document.getElementById('progress-circle');
        const circumference = 283;
        const offset = circumference - (percentage / 100) * circumference;
        circle.style.strokeDashoffset = offset;
    }

    // Add event listeners for real-time completion updates
    document.querySelectorAll('input[name="sex"], input[name="menstrual_cycle"], input[name="weather_sensitivity"]').forEach(input => {
        input.addEventListener('change', updateCompletion);
    });
    document.getElementById('age_group').addEventListener('change', updateCompletion);
    document.getElementById('family_history').addEventListener('input', updateCompletion);

    // Form submission
    document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoading();

        const formData = {
            sex: document.querySelector('input[name="sex"]:checked')?.value || '',
            age_group: document.getElementById('age_group').value,
            comorbidities: comorbidities.join(', '),
            family_history: document.getElementById('family_history').value,
            menstrual_cycle: document.querySelector('input[name="menstrual_cycle"]:checked')?.value || '',
            weather_sensitivity: document.querySelector('input[name="weather_sensitivity"]:checked')?.value || ''
        };

        try {
            const response = await fetch('/api/profile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            const data = await response.json();
            hideLoading();

            if (response.ok) {
                showToast('Profile updated successfully! âœ“', 'success');
                originalFormData = { ...formData };
            } else {
                showToast(data.error || 'Update failed', 'error');
            }
        } catch (error) {
            hideLoading();
            showToast('Network error. Please try again.', 'error');
        }
    });

    // Reset form
    function resetForm() {
        if (confirm('Reset all changes to last saved values?')) {
            loadProfile();
            showToast('Changes reset', 'info');
        }
    }

    // Export data
    function exportData() {
        showToast('Preparing data export...', 'info');
        // Implement data export functionality
    }

    // Delete account
    function confirmDeleteAccount() {
        const confirmation = prompt('Type "DELETE" to confirm account deletion:');
        if (confirmation === 'DELETE') {
            showLoading();
            showToast('This feature is not yet implemented', 'warning');
            hideLoading();
        }
    }
</script>
{% endblock %}